presubmits:
  - name: pull-banka-3-frontend-e2e
    always_run: true
    decorate: true
    spec:
      containers:
        - image: harbor.k8s.elab.rs/base-images/base:java-17-node-18-docker
          command:
            - /bin/bash
            - -c
            - |
              set -euo pipefail

              collectRecordings() {
                cp -r ./cypress/videos /logs/artifacts
                cp -r ./cypress/screenshots /logs/artifacts

                echo "${GCSWEB_URL}/prow-logs/pr-logs/pull/${REPO_OWNER}_${REPO_NAME}/${PULL_NUMBER}/${JOB_NAME}/${BUILD_NUMBER}/artifacts/videos" > /logs/artifacts/videos.link.txt
                echo "${GCSWEB_URL}/prow-logs/pr-logs/pull/${REPO_OWNER}_${REPO_NAME}/${PULL_NUMBER}/${JOB_NAME}/${BUILD_NUMBER}/artifacts/screenshots" > /logs/artifacts/screenshots.link.txt
              }

              cd ..
              git clone https://github.com/RAF-SI-2023/Banka-3-Backend.git ./Banka-3-Backend
              
              git clone https://github.com/RAF-SI-2023/Banka-3-Infrastructure.git ./Banka-3-Infrastructure

              cd ./Banka-3-Infrastructure
              
              echo "BACKEND_REPO_ABSOLUTE_PATH=/home/prow/go/src/github.com/RAF-SI-2023/Banka-3-Backend" > .env 
              echo "INFRA_REPO_ABSOLUTE_PATH=/home/prow/go/src/github.com/RAF-SI-2023/Banka-3-Infrastructure" >> .env
              echo "FRONTEND_REPO_ABSOLUTE_PATH=/home/prow/go/src/github.com/RAF-SI-2023/Banka-3-Frontend" >> .env

              start-docker.sh

              docker compose --profile user-service --profile bank-service --profile all up -d

              cd ..
              cd ./Banka-3-Frontend
              
              sleep 120

              mkdir -p ./cypress/screenshots ./cypress/videos

              npm install cypress --save-dev

              npx cypress run


              trap collectRecordings EXIT

          securityContext:
            privileged: true
          imagePullPolicy: Always